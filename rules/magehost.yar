/* 
Whitelist is in 'magehost_whitelist.json'
When updating: Make sure you check & understand the source code before adding.
# cat result.txt | sed -r 's/\/data\/vhosts\/[-a-z0-9\.]+\/(httpdocs|magento2)\///' | awk '{ print "  \"" $1 "\": \"" $2 " " $3 "\"," }'
*/

global private rule malware_size {
    meta:
        description = "Limit on file size"
    condition:
        /* uint16(0) == 0x4B50 and filesize < 3MB */
        filesize < 500KB
}


rule fromCharCode_in_unicode {
    strings: $ = "\\u0066\\u0072\\u006f\\u006d\\u0043\\u0068\\u0061\\u0072\\u0043\\u006f\\u0064\\u0065"
    condition: any of them
}

rule function_through_object {
    strings: 
        $ = "['eval']"
        $ = "['unescape']"
        $ = "['charCodeAt']"
        $ = "['fromCharCode']"
    condition: 2 of them
}

rule hex_script {
    strings:
        $ = "\\x73\\x63\\x72\\x69\\x70\\x74\\x22"
    condition: any of them
}

rule php_obf_malfunctions {
    strings:
        $ = /\b(eval|str_rot13|gzinflate|base64_decode|gzuncompress)\(\s*(str_rot13|gzinflate|base64_decode|gzuncompress)\(/
    condition: any of them
}

rule fopo_obfuscator {
    strings:
        $ = "www.fopo.com.ar"
    condition: any of them
}

rule obf_base64_decode {
    strings: $ = "\\x62\\x61\\x73\\145\\x36\\x34\\x5f\\x64\\x65\\143\\x6f\\144\\145"
    condition: any of them
}

rule html_upload {
    strings: 
        $ = "<input type='submit' name='upload' value='upload'>"
        $ = "if($_POST['upload'])"
    condition: any of them
}

rule scriptkiddies {
    strings:
        $ = "lastc0de@Outlook.com" nocase
        $ = "CodersLeet" nocase
        $ = "AgencyCaFc" nocase
        $ = "IndoXploit" nocase
        $ = "Kapaljetz666" nocase
    condition: any of them
}

rule eval_with_comments {
	strings:
		$ = /(^|\s)eval\s*\/\*.{,128}\*\/\s*\(/
	condition: any of them
}
